
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Remote Kamera via Browser (v2 dengan Rekam & Fitur Lain)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #111;
      color: #eee;
      text-align: center;
    }
    video {
      width: 100%;
      max-width: 800px;
      background: #000;
      border: 2px solid #444;
      margin: 10px auto;
      display: block;
    }
    .container {
      max-width: 900px;
      margin: auto;
    }
    button {
      padding: 12px 24px;
      margin: 10px 5px;
      font-size: 1.1rem;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #eee;
    }
    button:hover { background: #555; }
    button:disabled { background: #222; cursor: not-allowed; }
    #status {
      margin: 15px 0;
      font-size: 1.1rem;
      color: #0f0;
      min-height: 1.5em;
    }
    #error {
      color: #f55;
    }
    #recordTime { color: #ff0; font-size: 1.2rem; display: none; }
    #downloadLink { margin: 10px; display: none; color: #0ff; }
    #broadcasterControls, #viewerControls { margin: 20px 0; display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2>Remote Kamera Sederhana (WebRTC) - Dengan Rekam & Fitur Lain</h2>
  
  <div>
    <button id="btnStart">Mulai Broadcast Kamera (Perangkat A)</button>
    <button id="btnView">Lihat Kamera Remote (Perangkat B)</button>
  </div>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>
  
  <div id="broadcasterControls">
    <h3>Kontrol Broadcaster</h3>
    <button id="btnSwitchCamera">Ganti Kamera (Depan/Belakang)</button>
    <button id="btnToggleTorch">Nyalakan/Matikan Flashlight</button>
    <button id="btnSnapPhoto">Ambil Foto</button>
    <button id="btnToggleAudio">Aktifkan/Matikan Audio</button>
    <button id="btnFullScreenLocal">Full Screen</button>
  </div>
  
  <div id="viewerControls">
    <h3>Kontrol Viewer</h3>
    <button id="btnRecord">Mulai Rekam</button>
    <button id="btnStopRecord" disabled>Stop Rekam</button>
    <button id="btnSnapPhotoViewer">Ambil Foto</button>
    <button id="btnFullScreenRemote">Full Screen</button>
    <div id="recordTime">Waktu rekam: 00:00</div>
    <a id="downloadLink" download="rekaman.webm">Download Rekaman</a>
  </div>
  
  <div id="status">Status: Siap</div>
  <div id="error"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ==================== KONFIGURASI ====================
const socket = io();
let localStream = null;
let peerConnection = null;
let isBroadcaster = false;
let facingMode = 'environment'; // default belakang
let audioEnabled = false; // default mati
let torchEnabled = false;
let mediaRecorder = null;
let recordedChunks = [];
let recordTimer = null;
let recordStartTime = null;

const config = { 
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun1.l.google.com:19302" },
    { urls: "stun:stun2.l.google.com:19302" },
    { 
      urls: "turn:openrelay.metered.ca:80",
      username: "openrelayproject",
      credential: "openrelayproject"
    },
    { 
      urls: "turn:openrelay.metered.ca:443",
      username: "openrelayproject",
      credential: "openrelayproject"
    }
  ]
};

// Elements
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const statusEl = document.getElementById('status');
const errorEl = document.getElementById('error');
const broadcasterControls = document.getElementById('broadcasterControls');
const viewerControls = document.getElementById('viewerControls');
const btnSwitchCamera = document.getElementById('btnSwitchCamera');
const btnToggleTorch = document.getElementById('btnToggleTorch');
const btnSnapPhoto = document.getElementById('btnSnapPhoto');
const btnToggleAudio = document.getElementById('btnToggleAudio');
const btnFullScreenLocal = document.getElementById('btnFullScreenLocal');
const btnRecord = document.getElementById('btnRecord');
const btnStopRecord = document.getElementById('btnStopRecord');
const btnSnapPhotoViewer = document.getElementById('btnSnapPhotoViewer');
const btnFullScreenRemote = document.getElementById('btnFullScreenRemote');
const recordTimeEl = document.getElementById('recordTime');
const downloadLink = document.getElementById('downloadLink');

function setStatus(msg) {
  statusEl.textContent = msg;
  console.log("[STATUS]", msg);
}

function setError(msg) {
  errorEl.textContent = msg;
  console.error("[ERROR]", msg);
}

// ==================== UPDATE STREAM ====================
async function updateStream() {
  try {
    // Stop tracks lama jika ada (agar tidak leak resource)
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }

    setStatus('Membuat stream baru...');
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: facingMode
      },
      audio: audioEnabled
    });
    
    localVideo.srcObject = localStream;
    setStatus('Stream lokal diperbarui');

    // Update torch setelah stream baru (jika torchEnabled dan support)
    if (torchEnabled) {
      const videoTrack = localStream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities?.().torch) {
        await videoTrack.applyConstraints({ advanced: [{ torch: true }] });
      }
    }

    // Update peerConnection jika sudah ada
    if (peerConnection && localStream) {
      const videoTrack = localStream.getVideoTracks()[0];
      if (!videoTrack) {
        setError('Tidak ada video track di stream baru');
        return;
      }

      // Cari sender video yang ada
      let sender = peerConnection.getSenders().find(s => s.track?.kind === 'video');

      if (sender) {
        // Sender ada → replace
        console.log('Replace existing video track');
        await sender.replaceTrack(videoTrack);
      } else {
        // Tidak ada sender → tambah baru (biasanya broadcaster side)
        console.log('Add new video track (no existing sender)');
        peerConnection.addTrack(videoTrack, localStream);
      }

      // Jika ada audio dan audioEnabled
      if (audioEnabled) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
          let audioSender = peerConnection.getSenders().find(s => s.track?.kind === 'audio');
          if (audioSender) {
            await audioSender.replaceTrack(audioTrack);
          } else {
            peerConnection.addTrack(audioTrack, localStream);
          }
        }
      }
    }

  } catch (err) {
    setError('Gagal update stream: ' + err.message);
    console.error(err);
  }
}

// ==================== TOGGLE TORCH ====================
async function toggleTorch() {
  if (!localStream) return;
  const videoTrack = localStream.getVideoTracks()[0];
  if (!videoTrack.getCapabilities || !videoTrack.getCapabilities().torch) {
    setError('Torch tidak support di device ini');
    return;
  }
  torchEnabled = !torchEnabled;
  await videoTrack.applyConstraints({ advanced: [{ torch: torchEnabled }] });
  btnToggleTorch.textContent = torchEnabled ? 'Matikan Flashlight' : 'Nyalakan Flashlight';
}

// ==================== SNAP PHOTO ====================
function snapPhoto(videoEl) {
  const canvas = document.createElement('canvas');
  canvas.width = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  canvas.getContext('2d').drawImage(videoEl, 0, 0);
  const dataURL = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = 'snapshot.png';
  link.click();
}

// ==================== RECORDING ====================
function startRecording() {
  if (!remoteVideo.srcObject) {
    setError('Tidak ada stream remote untuk direkam');
    return;
  }
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(remoteVideo.srcObject, { mimeType: 'video/webm' });
  
  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) recordedChunks.push(e.data);
  };
  
  mediaRecorder.onstop = () => {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'rekaman.webm';
    downloadLink.style.display = 'block';
    setStatus('Rekaman selesai. Download siap!');
  };
  
  mediaRecorder.start();
  btnRecord.disabled = true;
  btnStopRecord.disabled = false;
  recordTimeEl.style.display = 'block';
  recordStartTime = Date.now();
  updateRecordTime();
  setStatus('Sedang merekam...');
}

function stopRecording() {
  if (mediaRecorder) {
    mediaRecorder.stop();
    clearInterval(recordTimer);
    btnRecord.disabled = false;
    btnStopRecord.disabled = true;
    recordTimeEl.textContent = 'Waktu rekam: 00:00';
    recordTimeEl.style.display = 'none';
  }
}

function updateRecordTime() {
  recordTimer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
    const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const sec = String(elapsed % 60).padStart(2, '0');
    recordTimeEl.textContent = `Waktu rekam: \( {min}: \){sec}`;
  }, 1000);
}

// ==================== FULL SCREEN ====================
function requestFullScreen(videoEl) {
  if (videoEl.requestFullscreen) videoEl.requestFullscreen();
  else if (videoEl.webkitRequestFullscreen) videoEl.webkitRequestFullscreen();
  else if (videoEl.msRequestFullscreen) videoEl.msRequestFullscreen();
}

// ==================== BUAT PEER CONNECTION ====================
function createPeerConnection() {
  const pc = new RTCPeerConnection(config);

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      socket.emit('candidate', { candidate: e.candidate });
    }
  };

  pc.oniceconnectionstatechange = () => {
    const state = pc.iceConnectionState;
    console.log('ICE Connection state:', state);
    setStatus(`Status: ${state}`);
    
    if (state === 'connected' || state === 'completed') {
      setStatus('Koneksi WebRTC berhasil!');
    } else if (state === 'failed' || state === 'disconnected') {
      setError('Koneksi gagal. Coba restart atau tambah TURN server.');
    }
  };

  pc.ontrack = (e) => {
    console.log('ontrack fired! Remote stream diterima', e.streams[0]);
    const remoteStream = e.streams[0];
    remoteVideo.srcObject = null; // force refresh
    remoteVideo.srcObject = remoteStream;
    
    // Force unmute tracks
    remoteStream.getTracks().forEach(track => {
      track.enabled = true;
      track.muted = false;
    });
    
    setStatus('Sedang menampilkan kamera remote!');
    viewerControls.style.display = 'block';
  };

  pc.onconnectionstatechange = () => {
    console.log('Connection state:', pc.connectionState);
  };

  return pc;
}

// ==================== MODE BROADCASTER ====================
document.getElementById('btnStart').onclick = async () => {
  if (localStream) return setStatus('Kamera sudah aktif');

  await updateStream();
  broadcasterControls.style.display = 'block';
  isBroadcaster = true;
  socket.emit('register', 'broadcaster');
};

// ==================== EVENT BROADCASTER ====================
btnSwitchCamera.onclick = async () => {
  facingMode = facingMode === 'environment' ? 'user' : 'environment';
  await updateStream();
};

btnToggleTorch.onclick = toggleTorch;

btnSnapPhoto.onclick = () => snapPhoto(localVideo);

btnToggleAudio.onclick = async () => {
  audioEnabled = !audioEnabled;
  btnToggleAudio.textContent = audioEnabled ? 'Matikan Audio' : 'Aktifkan Audio';
  await updateStream();
};

btnFullScreenLocal.onclick = () => requestFullScreen(localVideo);

// ==================== MODE VIEWER ====================
document.getElementById('btnView').onclick = async () => {
  if (peerConnection) return setStatus('Sudah / sedang connect');

  setStatus('Viewer: Membuat koneksi...');
  peerConnection = createPeerConnection();

  // Tambahkan transceiver untuk receive video (dan audio jika perlu)
  peerConnection.addTransceiver('video', { direction: 'recvonly' });
  if (audioEnabled) peerConnection.addTransceiver('audio', { direction: 'recvonly' });

  try {
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('offer', { sdp: peerConnection.localDescription });
  } catch (err) {
    setError('Gagal membuat offer: ' + err.message);
  }
};

// ==================== EVENT VIEWER ====================
btnRecord.onclick = startRecording;
btnStopRecord.onclick = stopRecording;
btnSnapPhotoViewer.onclick = () => snapPhoto(remoteVideo);
btnFullScreenRemote.onclick = () => requestFullScreen(remoteVideo);

// ==================== SIGNALING HANDLER ====================
socket.on('registered', (role) => {
  setStatus(`Terdaftar sebagai ${role}`);
});

socket.on('broadcaster-ready', () => {
  if (!isBroadcaster) {
    setStatus('Broadcaster terdeteksi! Klik "Lihat Kamera Remote" untuk connect.');
  }
});

socket.on('offer', async (data) => {
  if (!isBroadcaster) return;

  if (!peerConnection) {
    peerConnection = createPeerConnection();
  }

  // Pastikan tracks ditambahkan SEBELUM setRemoteDescription
  if (localStream) {
    localStream.getTracks().forEach(track => {
      // Cek apakah sender sudah ada untuk kind ini
      const existingSender = peerConnection.getSenders().find(s => s.track?.kind === track.kind);
      if (!existingSender) {
        console.log('Menambahkan track baru ke PC:', track.kind);
        peerConnection.addTrack(track, localStream);
      } else {
        console.log('Sender sudah ada untuk', track.kind);
      }
    });
  }

  try {
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('answer', { sdp: peerConnection.localDescription });
    setStatus('Offer diterima, mengirim answer...');
  } catch (err) {
    setError('Gagal handle offer: ' + err.message);
  }
});

socket.on('answer', async (data) => {
  if (isBroadcaster) return;

  if (!peerConnection) return;

  try {
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
    setStatus('Answer diterima, menunggu ICE...');
  } catch (err) {
    setError('Gagal set answer: ' + err.message);
  }
});

socket.on('candidate', async (data) => {
  if (!peerConnection) return;
  try {
    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
  } catch (err) {
    console.warn('Gagal tambah candidate:', err);
  }
});

socket.on('broadcaster-disconnected', () => {
  setError('Broadcaster terputus. Silakan mulai ulang broadcast.');
  if (remoteVideo.srcObject) {
    remoteVideo.srcObject = null;
  }
});

socket.on('error', (msg) => {
  setError('Server: ' + msg);
});

// Debug awal
console.log("Halaman dimuat. Buka console (F12) untuk debug detail.");
</script>
</body>
</html>
